# Построение адаптивного ICC-профиля по двум температурам

## 🔹 Шаг 1. Подготовка эталона и мишени

1. Создать таргет .ti1 с 255 градациями серого:
   ```bash
   targen -d3 -g255 gray_target
   ```

2. Сгенерировать .ti3:
   ```bash
   printtarg -iCM -h -T gray_target
   colprof -v -qm -D"Gray Ref" gray_target
   ```

3. **Итеративный процесс фильтрации слипшихся патчей**:
   ```bash
   python filter_ti3.py gray_target.ti3 gray_filtered.ti1
   printtarg -iCM -h -T gray_filtered
   ```
   - Важно: скрипт оставляет только те патчи, которые различимы по ΔE
   - Результат: оптимизированная мишень с различимыми градациями серого

4. Печать и использование полученного таргета для дальнейших шагов.

## 🔹 Шаг 2. Цифровая съёмка отпечатанной мишени

1. Снимаем при 3000K и 5000K, в RAW, linear (dcraw).
   - Освещение: CRI ≥ 95
   - Камера: съёмка в RAW, ручной режим экспозиции и ББ

2. **Съёмка с брекетингом и выбор оптимальной экспозиции**:
   - Серия снимков с разной экспозицией
   - Конвертация без тоновых преобразований:
     ```bash
     dcraw -v -T -6 -4 -o 0 -q 3 -W IMG_XXXX.RAW
     ```

3. Анализ и выбор оптимального кадра:
   ```bash
   scanin -v -p -a digital_3000.tif base.cht gray_filtered.ti1
   scanin -v -p -a digital_5000.tif base.cht gray_filtered.ti1
   ```

4. Оценка точности по критериям:
   - Среднее ∆E (mean DE) - должно быть наименьшим
   - Максимальное ∆E (max DE) - без катастрофических выбросов
   - 95-й перцентиль (ΔE95%) - не должен выходить за 2.5-3.0

5. Получаем: digital_3000.ti3, digital_5000.ti3 — эталонная реакция камеры.

## 🔹 Шаг 3. Съёмка таргета на плёнку

1. Один и тот же таргет снимаем:
   - при 3000K → кадр film_3000K
   - при 5000K → кадр film_5000K

2. **Съёмка с расширенным брекетингом**:
   - Брекетинг ±1 EV с шагом 0.5 EV
   - Фиксированная камера и композиция
   - Выбираем лучший кадр по деталям теней/светов

## 🔹 Шаг 4. Проявка и цифровой пересъём негативов

1. Проявка всей серии в одном проявителе с точным соблюдением времени и температуры.

2. Пересъёмка негативов с фиксированным white balance (например, D50):
   - Освещение стабильное, без автонастроек
   - Камера, масштаб и ракурс идентичны цифровому эталону

3. Конвертация в 16bit TIFF (без тоновых кривых):
   ```bash
   dcraw -v -T -6 -o 0 -q 3 -W IMG_XXXX.RAW
   ```

4. Перепривязка сетки патчей:
   - Накладывается исходная сетка патчей
   - Сетка вручную подгоняется под патчи на негативе
   - Сохраняется обновлённая версия сетки (.cht)

5. Анализ и выбор оптимального кадра:
   ```bash
   scanin -v -p -a film_3000K.tif corrected.cht gray_filtered.ti1
   scanin -v -p -a film_5000K.tif corrected.cht gray_filtered.ti1
   ```

6. Выбор лучшего кадра для каждой температуры по критериям:
   - Минимальное среднее отклонение (mean ∆E)
   - Отсутствие катастрофических выбросов (max ∆E)

## 🔹 Шаг 5. Построение ICC-профилей по двум температурам

1. Получаем .ti3:
   - film_3000K.ti3
   - film_5000K.ti3

2. Генерируем два отдельных ICC:
   ```bash
   colprof -v -qm -al -D"Neg 3000K" film_3000K
   colprof -v -qm -al -D"Neg 5000K" film_5000K
   ```

## 🔹 Шаг 6. Сборка объединённого профиля

1. Объединяем .ti3 в единый файл: neg_all.ti3
   - Ставим метку температуры вручную (в поле COMMENT или в отдельную колонку)

2. Пишем Python-скрипт, который:
   - Читает neg_all.ti3
   - Интерполирует Lab-значения по температуре (например, через interp1d)
   - По заданной целевой температуре (например, target_temp = 4000) выдаёт результирующий .ti3

3. Генерируем итоговый профиль:
   ```bash
   colprof -v -qm -al -D"Adaptive BW Neg Profile" neg_interp
   ```

4. Опционально: интерполяция промежуточных температур
   ```bash
   # Пример интерполяции в середину (0.5 между 3000 и 5000K)
   ti3_interp -v -i film_3000K.ti3 film_5000K.ti3 0.5 > film_4000K.ti3
   ```