# Оптимальная экспозиция при пересъёмке: автоматический выбор кадра

## Зачем нужен этот инструмент

При пересъёмке плёнки, слайдов, архивных документов или цветовых мишеней мы 
сталкиваемся с задачей репродукции, а не творчества. Это принципиальное 
отличие: если в художественной фотографии экспозиция может быть частью стиля, 
то в репродукции главное — точность. Мы стремимся передать максимум информации 
из оригинала в цифровую форму, без потерь, с сохранением градаций, плотностей 
и тональных переходов.

Цифровая камера не знает, что она снимает. Сенсор фиксирует свет, но не 
понимает, что перед ним: чертёж, негатив, картина маслом или реальная сцена. 
Поэтому задача выбора правильной экспозиции ложится на нас. И чаще всего 
универсального ответа нет — сцена сложная, материал нестандартный, освещение 
специфическое. Мы делаем серию кадров с разными параметрами (брекетинг), 
чтобы потом вручную выбрать наилучший.

Но какой кадр считать лучшим?

В репродукции это не тот, что «выглядит красиво», а тот, где **максимум 
деталей сохранён** — в тенях, в светах, в средних тонах. Это и есть цель 
алгоритма: автоматически выбрать кадр, наиболее насыщенный содержанием, без 
пересвета и провалов.

## Что делает система

Инструмент анализирует серию RAW-файлов, снятых с разной экспозицией, и 
выбирает один кадр, в котором:

- наименьшая вероятность потерь в тенях и светах
- максимальный используемый динамический диапазон  
- минимальный уровень шума при сохранении деталей

Это достигается с помощью двухфазного анализа: сначала отбираются кадры с 
яркостью, близкой к эталонной (18% серый в цифровом представлении), затем 
оценивается структура гистограммы и распределение данных.

## Как пользоваться

1. Снимите серию кадров с брекетингом (например, ±2 EV, шаг 0.5 EV)
2. Передайте их в инструмент в виде RAW кадров
3. Получите путь к выбранному кадру — он и станет вашим техническим эталоном
4. Используйте его для дальнейшей работы: профилирования, оценки, печати

Алгоритм работает по следующей схеме:
1. **Загрузка изображения** — чтение файла и преобразование в рабочее 
   цветовое пространство
2. **Расчёт гистограммы** — анализ распределения яркостей по каналам RGB 
   и построение luminance-гистограммы
3. **Детекция проблем** — поиск клиппинга в светах и тенях, анализ 
   контраста, проверка на засветы
4. **Оценка резкости** — вычисление градиентов и анализ высокочастотных 
   компонент
5. **Цветовой анализ** — проверка насыщенности, баланса белого, цветовых 
   сдвигов
6. **Интегральная оценка** — взвешенное суммирование всех метрик с 
   применением штрафных коэффициентов
7. **Ранжирование** — сортировка файлов по итоговой оценке и выбор 
   оптимального

## Принцип работы: два шага вместо догадок

Алгоритм основан на простой и надёжной идее: сначала грубый отбор, затем 
точное уточнение. Такой подход давно используется в промышленности, в спорте, 
в анализе данных. Мы сначала ищем среди всего множества те варианты, которые 
"похожи на нужные", а затем внимательно сравниваем только их.

### Шаг M1: подбор по средней яркости

Цель первого шага — найти те кадры, где средняя яркость соответствует 
условному "эталону". В фотографии принято считать, что сцена, освещённая 
равномерно, даёт среднюю яркость около 18% от полного белого. Это та самая 
"серая карта", на которую ссылаются экспонометры и инструкции камер.

Однако история этого стандарта уходит корнями в аналоговую эпоху. В начале 
1940-х Kodak разработала систему зонного экспонирования, основанную на 
принципе, что средняя рефлексия типичной сцены составляет 18% от падающего 
света. Это значение стало базой для калибровки экспонометров и позже — 
матричных систем замера в цифровых камерах.

В середине 2000-х профессиональные системы цветокоррекции начали использовать 
зональный анализ — разделение изображения на области с различными 
характеристиками экспозиции, автоматизация методов Анселя Адамса. Такой 
подход учитывал неравномерность освещения и локальные особенности сцены. 
Системы Da Vinci и Baselight внедрили алгоритмы автоматического выравнивания, 
основанные на анализе распределения яркостей по зонам.

В цифровом 16-битном изображении эталонные 18% соответствуют примерно 11796 
по шкале от 0 до 65535. Для понимания работы с компенсацией экспозиции 
важно знать, как это значение изменяется:

- **7374** (-1 EV) — недоэкспонированный кадр, тени провалены
- **9276** (-0.5 EV) — слегка недоэкспонированный, но часто оптимальный 
  для сохранения светов
- **11796** (0 EV) — эталонная экспозиция по стандарту 18% серой карты
- **14925** (+0.5 EV) — слегка переэкспонированный, хорош для тёмных сцен
- **18874** (+1 EV) — переэкспонированный, высокий риск потери светов

Алгоритм сравнивает каждый кадр и выбирает те, где средняя яркость ближе 
всего к эталонной точке, учитывая специфику материала.

### Шаг M2: уточнение по структуре гистограммы

Второй шаг более тонкий. Среди отобранных кандидатов мы анализируем:

- **Клиппинг** в тенях и светах — кадры с провалами в чёрное или 
  выбитыми в белое областями отбрасываются (потеря деталей необратима)
- **Рабочую ширину** — насколько полно используется весь диапазон от 
  самых тёмных до самых светлых участков: узкий диапазон означает 
  "плоскую" картинку без контраста
- **Оценку шума** — чем более гладкими и равномерными выглядят однотонные 
  области (небо, фон, серые поля), тем выше качество. Шумный кадр имеет 
  "зернистость" даже там, где должна быть ровная поверхность
- **Равномерность** — плавность переходов между тонами: хорошая 
  гистограмма выглядит как холмы без резких обрывов и пустот, плохая — 
  как частокол с провалами между "зубьями"


Интегральная оценка вычисляется как взвешенная сумма всех факторов с 
штрафными коэффициентами за выявленные проблемы. Файл с максимальной оценкой 
выбирается как оптимальный.

## Преимущества и ограничения методики

### Преимущества

**Устойчивость к человеческому фактору**
Инструмент работает одинаково днём и ночью, после кофе и без, на любом 
мониторе и в любых условиях. Один и тот же набор файлов всегда даёт один 
и тот же результат.

**Работает «вслепую»**
Нет необходимости знать, что именно в кадре. Алгоритм анализирует только 
свет и структуру, что удобно при потоковой съёмке.

**Прямо на обычном компьютере**
Без нейросетей, без платных лицензий, без облачных сервисов. Только Python, 
NumPy и здравый смысл.

**Масштабируемость**
Можно прогонять как 3 кадра, так и 300. Время обработки растёт линейно.

### Ограничения

**Средняя яркость не всегда отражает привычную экспозицию**
Если у вас заснеженный пейзаж или белая мишень — алгоритм выберет кадр 
темнее привычного, но с максимумом деталей. Снег можно потом осветлить, 
а потерянные света восстановить нельзя.

**Узкий диапазон может быть оптимальным**
Фотография с мягким градиентом может получить низкую оценку по контрасту, 
но если это соответствует оригиналу — алгоритм всё равно выберет кадр 
с лучшей проработкой деталей.

**Архивные и выцветшие материалы — алгоритм справляется**
Если негатив старый, выгоревший, с неровной базой — первый уровень отбора 
всё равно найдёт кадр с максимумом сохранившейся информации. Конкуренты 
будут близки по качеству, но выбор останется обоснованным.

## Практические сценарии применения

- **Настройка пересъёмки негативов** — пробный брекетинг на одном кадре 
  поможет настроить параметры для всей серии
- **Выбор лучшего кадра для профилирования** — при съёмке цветовых мишеней 
  важна максимальная сохранность градаций между патчами
- **Цифровизация редких материалов** — если материал единственный и 
  повторная съёмка невозможна, автоматический анализ снижает риски
- **Контроль при съёмке документации** — встраивание в контрольную цепочку 
  для анализа каждого кадра сразу после съёмки


## Кому это особенно полезно

- **Фотолаборатории и реставраторы** — для оцифровки негативов, слайдов 
  и отпечатков
- **Архивисты** — при работе с документами, чертежами и техническими 
  материалами
- **Преподаватели** — для демонстрации принципов экспозиции на практике
- **Фотографы** — когда съёмка мишеней требует точного контроля
- **Разработчики ICC-профилей** — для отбора эталонного кадра с мишени

Этот модуль можно встроить в лабораторный процесс, использовать в командной 
работе или запускать вручную. Он надёжен, предсказуем и объясним.